#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)
options(error=traceback)

# Loading libraries
library(plyr)
library(ggplot2)

# Reading input arguments
usage = "This script should be called this way:
Rscript --vanilla analyse_schedule_jobs.R JOBS OUTPUT_METRICS_FILE WORKLOAD_NAME WORKLOAD_TYPE
    JOBS: the Batsim _jobs.csv output
    OUTPUT_METRICS_FILE: the directory in which the figures generated by this script are outputted
    WORKLOAD_NAME: the name of the workload being analysed
    WORKLOAD_TYPE: the type of the workload being analysed"

if (length(args)!=4)
    stop(usage, call.=FALSE)

jobs = read.csv(args[1])
output_file = args[2]
workload_name = args[3]
workload_type = args[4]

# Computing scheduling metrics
jobs_makespan = max(jobs$finish_time)
jobs_mean_stretch = mean(jobs$stretch)
jobs_mean_waiting_time = mean(jobs$waiting_time)
jobs_mean_turnaround_time = mean(jobs$turnaround_time)

# Translate submission times towards 0
jobs_min_submission_time = min(jobs$submission_time)
jobs['submission_time'] = jobs$submission_time - jobs_min_submission_time
jobs['starting_time'] = jobs$starting_time - jobs_min_submission_time
jobs['finish_time'] = jobs$finish_time - jobs_min_submission_time

# Compute stretch
jobs['stretch'] = jobs$turnaround_time / jobs$execution_time

# Compute bounded stretch
bounded_stretch_min_runtime = 125
jobs['bounded_stretch'] = jobs$turnaround_time / max(bounded_stretch_min_runtime, jobs$execution_time)

jobs_mean_bounded_stretch = mean(jobs$bounded_stretch)

jobs["type"] = workload_type

# Graph generation

#pdf("submission_times.pdf")
# plot(batsim$submission_time ~ batsim$jobID,
#     xlab="Job ID", ylab="Submission time",
#     main="Submission times of jobs")
# points(real$submission_time ~ real$jobID)
#dev.off()

##################
# METRICS OUTPUT #
##################

export_data = data.frame(workload_name = character(),
                         workload_type = character(),
                         makespan = double(),
                         mean_stretch = double(),
                         mean_bounded_stretch = double(),
                         mean_waiting_time = double(),
                         mean_turnaround_time = double(),
                         stringsAsFactors=FALSE)

export_data[1,] = c(workload_name,
                    workload_type,
                    jobs_makespan,
                    jobs_mean_stretch,
                    jobs_mean_bounded_stretch,
                    jobs_mean_waiting_time,
                    jobs_mean_turnaround_time)

write.table(export_data, output_file, sep=',', row.names=FALSE, quote=FALSE)
