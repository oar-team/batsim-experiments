#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)
options(error=traceback)

# Loading libraries
library(plyr)
library(ggplot2)

# Reading input arguments
usage = "This script should be called this way:
Rscript --vanilla compare_outputs.R BATSIM REAL OUTPUT_DIR WORKLOAD_NAME
    BATSIM: the Batsim _jobs.csv output
    REAL: the OAR output is a the same format as BATSIM_OUTPUT
    OUTPUT_DIR: the directory in which the figures generated by this script are outputted
    WORKLOAD_NAME: the name of the workload being analyzed"

if (length(args)!=4)
    stop(usage, call.=FALSE)

if (!dir.exists(args[3]))
    stop("Invalid OUTPUT_DIR parameter: directory does not exist", call.=FALSE)

batsim = read.csv(args[1])
real = read.csv(args[2])
output_dir = args[3]
workload_name = args[4]

# Computing scheduling metrics
batsim_makespan = max(batsim$finish_time)
batsim_mean_stretch = mean(batsim$stretch)
batsim_mean_waiting_time = mean(batsim$waiting_time)
batsim_mean_turnaround_time = mean(batsim$turnaround_time)

real_makespan = max(real$finish_time)
real_mean_stretch = mean(real$stretch)
real_mean_waiting_time = mean(real$waiting_time)
real_mean_turnaround_time = mean(real$turnaround_time)

makespan_difference = real_makespan - batsim_makespan
mean_stretch_difference = real_mean_stretch - batsim_mean_stretch
mean_waiting_time_difference = real_mean_waiting_time - batsim_mean_waiting_time
mean_turnaround_time_difference = real_mean_turnaround_time - batsim_mean_turnaround_time

# Translate submission times towards 0
batsim_min_submission_time = min(batsim$submission_time)
batsim['submission_time'] = batsim$submission_time - batsim_min_submission_time
batsim['starting_time'] = batsim$starting_time - batsim_min_submission_time
batsim['finish_time'] = batsim$finish_time - batsim_min_submission_time

real_min_submission_time = min(real$submission_time)
real['submission_time'] = real$submission_time - real_min_submission_time
real['starting_time'] = real$starting_time - real_min_submission_time
real['finish_time'] = real$finish_time - real_min_submission_time

# Compute stretch
batsim['stretch'] = batsim$turnaround_time / batsim$execution_time
real['stretch'] = real$turnaround_time / real$execution_time

# Compute bounded stretch
bounded_stretch_min_runtime = 125
batsim['bounded_stretch'] = batsim$turnaround_time / max(bounded_stretch_min_runtime, batsim$execution_time)
real['bounded_stretch'] = real$turnaround_time / max(bounded_stretch_min_runtime, real$execution_time)

batsim_mean_bounded_stretch = mean(batsim$bounded_stretch)
real_mean_bounded_stretch = mean(real$bounded_stretch)
mean_bounded_stretch_difference = real_mean_bounded_stretch - batsim_mean_bounded_stretch

# Setting working directory to OUTPUT_DIR
setwd(output_dir)

# Data manipulations
# Renaming columns to do an inner join
rename_mapping = c(
"jobID"="jobID",
"requested_number_of_processors"="real_requested_number_of_processors",
"success"="real_success",
"execution_time"="real_execution_time",
"waiting_time"="real_waiting_time",
"stretch"="real_stretch",
"allocated_processors"="real_allocated_processors",
"submission_time"="real_submission_time",
"requested_time"="real_requested_time",
"starting_time"="real_starting_time",
"finish_time"="real_finish_time",
"turnaround_time"="real_turnaround_time",
"consumed_energy"="real_consumed_energy",
"bounded_stretch"="real_bounded_stretch")

real_renamed = rename(real, rename_mapping)

m = merge(batsim, real_renamed, by="jobID")
m['submission_time_difference'] = m$real_submission_time - m$submission_time
m['starting_time_difference'] = m$real_starting_time - m$starting_time
m['finish_time_difference'] = m$real_finish_time - m$finish_time
m['execution_time_difference'] = m$real_execution_time - m$execution_time
m['normalized_execution_time_difference'] = m$execution_time_difference / m$execution_time
m['waiting_time_difference'] = m$real_waiting_time - m$waiting_time
m['turnaround_time_difference'] = m$real_turnaround_time - m$turnaround_time
m['stretch_difference'] = m$real_stretch - m$stretch
m['bounded_stretch_difference'] = m$real_bounded_stretch - m$bounded_stretch
m['makespan_difference'] = m$real_makespan - m$makespan

batsim["type"] = 'simulated'
real["type"] = 'real'
alldata = rbind(batsim, real)

# Graph generation

#pdf("submission_times.pdf")
# plot(batsim$submission_time ~ batsim$jobID,
#     xlab="Job ID", ylab="Submission time",
#     main="Submission times of jobs")
# points(real$submission_time ~ real$jobID)
#dev.off()

ratio.display = 4/3

fig_width=8
fig_height=6

# Submission times
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$submission_time)-min(alldata$submission_time))
ggplot(alldata, aes(x= jobID, y=submission_time)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("submission_times.pdf", width=fig_width, height=fig_height)

# Starting times
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$starting_time)-min(alldata$starting_time))
ggplot(alldata, aes(x= jobID, y=starting_time)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("starting_times.pdf", width=fig_width, height=fig_height)

# Finition times
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$finish_time)-min(alldata$finish_time))
ggplot(alldata, aes(x= jobID, y=finish_time)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("finish_times.pdf", width=fig_width, height=fig_height)


sub_times = alldata
sub_times['time'] = sub_times['submission_time']
sub_times['name'] = 'Submission time'

start_times = alldata
start_times['time'] = start_times['starting_time']
start_times['name'] = 'Start time'

finish_times = alldata
finish_times['time'] = finish_times['finish_time']
finish_times['name'] = 'Finish time'

ggplot(sub_times, aes(x=jobID, y=time)) +
    geom_point(data=sub_times, aes(color=name, shape=type)) + scale_shape_manual(values=(c(1,3))) +
    geom_point(data=start_times, aes(color=name, shape=type)) + scale_shape_manual(values=(c(1,3))) +
    geom_point(data=finish_times, aes(color=name, shape=type)) + scale_shape_manual(values=(c(1,3)))
ggsave("merged_times_scatterplot.pdf")

# Execution times
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$execution_time)-min(alldata$execution_time))
ggplot(alldata, aes(x= jobID, y=execution_time), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_point(aes(shape = type)) + scale_shape_manual(values=c(1,3)) +
    xlab("Job ID") + ylab("Execution time (s)") + theme(legend.title=element_blank()) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("execution_times_scatterplot.pdf", width=fig_width, height=fig_height)

ggplot(alldata, aes(x= execution_time, fill = type)) +
    geom_density(alpha=.5, aes(linetype = type))
ggsave("execution_times_distribution_density.pdf", width=fig_width, height=fig_height)

# Waiting times
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$waiting_time)-min(alldata$waiting_time))
ggplot(alldata, aes(x = jobID, y= waiting_time)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("waiting_times_scatterplot.pdf", width=fig_width, height=fig_height)

ggplot(alldata, aes(x= waiting_time, fill = type)) +
    geom_density(alpha=.5, aes(linetype = type))
ggsave("waiting_times_distribution_density.pdf", width=fig_width, height=fig_height)

# Turnaround time
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$turnaround_time)-min(alldata$turnaround_time))
ggplot(alldata, aes(x = jobID, y= turnaround_time), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_point(aes(shape = type)) + scale_shape_manual(values=c(1,3)) +
    xlab("Job ID") + ylab("Turnaround time (s)") + theme(legend.title=element_blank()) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("turnaround_times_scatterplot.pdf", width=fig_width, height=fig_height)

ggplot(alldata, aes(x= turnaround_time, fill = type), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_density(alpha=.5, aes(linetype = type)) +
    xlab("Turnaround time (s)") + theme(legend.title=element_blank())
ggsave("turnaround_times_distribution_density.pdf", width=fig_width, height=fig_height)

# Stretch
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$stretch)-min(alldata$stretch))
ggplot(alldata, aes(x = jobID, y= stretch)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("stretch_scatterplot.pdf", width=fig_width, height=fig_height)

ggplot(alldata, aes(x= stretch, fill = type)) +
    geom_density(alpha=.5, aes(linetype = type))
ggsave("stretch_distribution_density.pdf", width=fig_width, height=fig_height)

# Bounded stretch
ratio.values = (max(alldata$jobID)-min(alldata$jobID))/(max(alldata$bounded_stretch)-min(alldata$bounded_stretch))
ggplot(alldata, aes(x = jobID, y= bounded_stretch)) +
    geom_point(aes(color = type, shape = type)) + scale_shape_manual(values=c(1,3)) +
    coord_fixed(ratio=ratio.values / ratio.display) + theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))
ggsave("bounded_stretch_scatterplot.pdf", width=fig_width, height=fig_height)

ggplot(alldata, aes(x= bounded_stretch, fill = type)) +
    geom_density(alpha=.5, aes(linetype = type))
ggsave("bounded_stretch_distribution_density.pdf", width=fig_width, height=fig_height)

##########################
# Job-by-job differences #
##########################

ggplot(m, aes(x= jobID, y= submission_time_difference), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_point() +
    xlab("Job ID") + ylab("Submission time difference (s)")
ggsave("submission_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= starting_time_difference), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_point() +
    xlab("Job ID") + ylab("Starting time difference (s)")
ggsave("submission_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= finish_time_difference), axis.title.x=element.blank(), axis.title.y=element.blank()) +
    geom_point() +
    xlab("Job ID") + ylab("Finish time difference (s)")
ggsave("submission_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= execution_time_difference)) +
    geom_point()
ggsave("execution_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= execution_time_difference, color = execution_time)) +
    geom_point() + scale_color_gradient(low="lightgray", high="black") +
    xlab("job ID") + ylab("Execution time difference (s)")
ggsave("execution_time_difference_color.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= normalized_execution_time_difference)) +
    geom_point()
ggsave("normalized_execution_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= normalized_execution_time_difference, color = execution_time)) +
    geom_point() + scale_color_gradient(low="lightblue", high="black")
ggsave("normalized_execution_time_difference_color.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= waiting_time_difference)) +
    geom_point()
ggsave("waiting_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= turnaround_time_difference)) +
    geom_point()
ggsave("turnaround_time_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= stretch_difference)) +
    geom_point()
ggsave("stretch_difference.pdf", width=fig_width, height=fig_height)

ggplot(m, aes(x= jobID, y= bounded_stretch_difference)) +
    geom_point()
ggsave("bounded_stretch_difference.pdf", width=fig_width, height=fig_height)

###############
# CALIBRATION #
###############
thresh = 10
bad_calibrated_jobs = which(abs(m$execution_time_difference) > thresh)
bad_calibrated_jobs_export = m[bad_calibrated_jobs,]
bad_calibrated_jobs_export = bad_calibrated_jobs_export[c('jobID', 'execution_time', 'real_execution_time', 'execution_time_difference')]
write.table(bad_calibrated_jobs_export, "bad_calibrated_jobs.csv", row.names=FALSE)

size1_bad_calibrated_jobs = which(abs(m$execution_time_difference > thresh) & m$requested_number_of_processors == 1)
size1_bad_calibrated_jobs_export = m[size1_bad_calibrated_jobs,]
size1_bad_calibrated_jobs_export = size1_bad_calibrated_jobs_export[c('jobID', 'execution_time', 'real_execution_time', 'execution_time_difference')]
write.table(size1_bad_calibrated_jobs_export, "bad_calibrated_jobs_size1.csv", row.names=FALSE)

######################
# DIFFERENCES OUTPUT #
######################
submission_time_difference_mean = mean(m$submission_time_difference)
submission_time_difference_sd = sd(m$submission_time_difference)
execution_time_difference_mean = mean(m$execution_time_difference)
execution_time_difference_sd = sd(m$execution_time_difference)
waiting_time_difference_mean = mean(m$waiting_time_difference)
waiting_time_difference_sd = sd(m$waiting_time_difference)
turnaround_time_difference_mean = mean(m$turnaround_time_difference)
turnaround_time_difference_sd = sd(m$turnaround_time_difference)
stretch_difference_mean = mean(m$stretch_difference)
stretch_difference_sd = sd(m$stretch_difference)

export_data = data.frame(submission_time_difference_mean = double(),
                         submission_time_difference_sd = double(),
                         execution_time_difference_mean = double(),
                         execution_time_difference_sd = double(),
                         waiting_time_difference_mean = double(),
                         waiting_time_difference_sd = double(),
                         turnaround_time_difference_mean = double(),
                         turnaround_time_difference_sd = double(),
                         stretch_difference_mean = double(),
                         stretch_difference_sd = double(),

                         makespan_difference = double(),
                         mean_stretch_difference = double(),
                         mean_bounded_stretch_difference = double(),
                         mean_waiting_time_difference = double(),
                         mean_turnaround_time_difference = double(),

                         workload_name = character(),

                         batsim_makespan = double(),
                         real_makespan = double(),
                         batsim_mean_stretch = double(),
                         real_mean_stretch = double(),
                         batsim_mean_bounded_stretch = double(),
                         real_mean_bounded_stretch = double(),
                         batsim_mean_waiting_time = double(),
                         real_mean_waiting_time = double(),
                         batsim_mean_turnaround_time = double(),
                         real_mean_turnaround_time = double(),
                         stringsAsFactors=FALSE)

export_data[1,] = c(submission_time_difference_mean,
                   submission_time_difference_sd,
                   execution_time_difference_mean,
                   execution_time_difference_sd,
                   waiting_time_difference_mean,
                   waiting_time_difference_sd,
                   turnaround_time_difference_mean,
                   turnaround_time_difference_sd,
                   stretch_difference_mean,
                   stretch_difference_sd,

                   makespan_difference,
                   mean_stretch_difference,
                   mean_bounded_stretch_difference,
                   mean_waiting_time_difference,
                   mean_turnaround_time_difference,

                   workload_name,

                   batsim_makespan,
                   real_makespan,
                   batsim_mean_stretch,
                   real_mean_stretch,
                   batsim_mean_bounded_stretch,
                   real_mean_bounded_stretch,
                   batsim_mean_waiting_time,
                   real_mean_waiting_time,
                   batsim_mean_turnaround_time,
                   real_mean_turnaround_time)

write.table(export_data, "differences.csv", sep=',', row.names=FALSE, quote=FALSE)
