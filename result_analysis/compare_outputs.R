#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)
options(error=traceback)

# Loading libraries
library(plyr)
library(ggplot2)

# Reading input arguments
usage = "This script should be called this way:
Rscript --vanilla compare_outputs.R BATSIM REAL OUTPUT_DIR WORKLOAD_NAME
    BATSIM: the Batsim _jobs.csv output
    REAL: the OAR output is a the same format as BATSIM_OUTPUT
    OUTPUT_DIR: the directory in which the figures generated by this script are outputted
    WORKLOAD_NAME: the name of the workload being analyzed"

if (length(args)!=4)
    stop(usage, call.=FALSE)

if (!dir.exists(args[3]))
    stop("Invalid OUTPUT_DIR parameter: directory does not exist", call.=FALSE)

batsim = read.csv(args[1])
real = read.csv(args[2])
output_dir = args[3]
workload_name = args[4]

# Computing scheduling metrics
batsim_makespan = max(batsim$finish_time)
batsim_mean_stretch = mean(batsim$stretch)
batsim_mean_waiting_time = mean(batsim$waiting_time)
batsim_mean_turnaround_time = mean(batsim$turnaround_time)

real_makespan = max(real$finish_time)
real_mean_stretch = mean(real$stretch)
real_mean_waiting_time = mean(real$waiting_time)
real_mean_turnaround_time = mean(real$turnaround_time)

makespan_difference = real_makespan - batsim_makespan
mean_stretch_difference = real_mean_stretch - batsim_mean_stretch
mean_waiting_time_difference = real_mean_waiting_time - batsim_mean_waiting_time
mean_turnaround_time_difference = real_mean_turnaround_time - batsim_mean_turnaround_time

# Setting working directory to OUTPUT_DIR
setwd(output_dir)

# Data manipulations
# Renaming columns to do an inner join
rename_mapping = c(
"jobID"="jobID",
"requested_number_of_processors"="real_requested_number_of_processors",
"success"="real_success",
"execution_time"="real_execution_time",
"waiting_time"="real_waiting_time",
"stretch"="real_stretch",
"allocated_processors"="real_allocated_processors",
"submission_time"="real_submission_time",
"requested_time"="real_requested_time",
"starting_time"="real_starting_time",
"finish_time"="real_finish_time",
"turnaround_time"="real_turnaround_time",
"consumed_energy"="real_consumed_energy",
"makespan"="real_makespan",
"mean_stretch"="real_mean_stretch",
"mean_waiting_time"="real_mean_waiting_time",
"mean_turnaround_time"="real_mean_turnaround_time")

real_renamed = rename(real, rename_mapping)

m = merge(batsim, real_renamed, by="jobID")
m['submission_time_difference'] = m$real_submission_time - m$submission_time
m['execution_time_difference'] = m$real_execution_time - m$execution_time
m['waiting_time_difference'] = m$real_waiting_time - m$waiting_time
m['turnaround_time_difference'] = m$real_turnaround_time - m$turnaround_time
m['stretch_difference'] = m$real_stretch - m$stretch
m['makespan_difference'] = m$real_makespan - m$makespan
m['makespan_difference'] = m$real_makespan - m$makespan

batsim["simulated"] = TRUE
real["simulated"] = FALSE
alldata = rbind(batsim, real)

# Graph generation

#pdf("submission_times.pdf")
# plot(batsim$submission_time ~ batsim$jobID,
#     xlab="Job ID", ylab="Submission time",
#     main="Submission times of jobs")
# points(real$submission_time ~ real$jobID)
#dev.off()

# Submission times
ggplot(alldata, aes(x= jobID, y=submission_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("submission_times.pdf")

# Execution times
ggplot(alldata, aes(x= jobID, y=execution_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("execution_times_scatterplot.pdf")

ggplot(alldata, aes(x= execution_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("execution_times_distribution_density.pdf")

ggplot(alldata, aes(x= execution_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("execution_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= execution_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("execution_times_distribution_boxplot.pdf")

# Waiting times
ggplot(alldata, aes(x = jobID, y= waiting_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("waiting_times_scatterplot.pdf")

ggplot(alldata, aes(x= waiting_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("waiting_times_distribution_density.pdf")

ggplot(alldata, aes(x= waiting_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("waiting_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= waiting_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("waiting_times_distribution_boxplot.pdf")

# Turnaround time
ggplot(alldata, aes(x = jobID, y= turnaround_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("turnaround_times_scatterplot.pdf")

ggplot(alldata, aes(x= turnaround_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("turnaround_times_distribution_density.pdf")

ggplot(alldata, aes(x= turnaround_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("turnaround_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= turnaround_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("turnaround_times_distribution_boxplot.pdf")

# Stretch
ggplot(alldata, aes(x = jobID, y= stretch)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("stretch_scatterplot.pdf")

ggplot(alldata, aes(x= stretch, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("stretch_distribution_density.pdf")

ggplot(alldata, aes(x= stretch, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("stretch_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= stretch, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("stretch_distribution_boxplot.pdf")

# Job-by-job differences
ggplot(m, aes(x= jobID, y= submission_time_difference)) +
    geom_point()
ggsave("submission_time_difference.pdf")

ggplot(m, aes(x= jobID, y= execution_time_difference)) +
    geom_point()
ggsave("execution_time_difference.pdf")

ggplot(m, aes(x= jobID, y= waiting_time_difference)) +
    geom_point()
ggsave("waiting_time_difference.pdf")

ggplot(m, aes(x= jobID, y= turnaround_time_difference)) +
    geom_point()
ggsave("turnaround_time_difference.pdf")

ggplot(m, aes(x= jobID, y= stretch_difference)) +
    geom_point()
ggsave("stretch_difference.pdf")

###############
# CALIBRATION #
###############
thresh = 10
bad_calibrated_jobs = which(abs(m$execution_time_difference) > thresh)
bad_calibrated_jobs_export = m[bad_calibrated_jobs,]
bad_calibrated_jobs_export = bad_calibrated_jobs_export[c('jobID', 'execution_time', 'real_execution_time', 'execution_time_difference')]
write.table(bad_calibrated_jobs_export, "bad_calibrated_jobs.csv", row.names=FALSE)

size1_bad_calibrated_jobs = which(abs(m$execution_time_difference > thresh) & m$requested_number_of_processors == 1)
size1_bad_calibrated_jobs_export = m[size1_bad_calibrated_jobs,]
size1_bad_calibrated_jobs_export = size1_bad_calibrated_jobs_export[c('jobID', 'execution_time', 'real_execution_time', 'execution_time_difference')]
write.table(size1_bad_calibrated_jobs_export, "bad_calibrated_jobs_size1.csv", row.names=FALSE)

######################
# DIFFERENCES OUTPUT #
######################
submission_time_difference_mean = mean(m$submission_time_difference)
submission_time_difference_sd = sd(m$submission_time_difference)
execution_time_difference_mean = mean(m$execution_time_difference)
execution_time_difference_sd = sd(m$execution_time_difference)
waiting_time_difference_mean = mean(m$waiting_time_difference)
waiting_time_difference_sd = sd(m$waiting_time_difference)
turnaround_time_difference_mean = mean(m$turnaround_time_difference)
turnaround_time_difference_sd = sd(m$turnaround_time_difference)
stretch_difference_mean = mean(m$stretch_difference)
stretch_difference_sd = sd(m$stretch_difference)

makespan_difference = real_makespan - batsim_makespan
mean_stretch_difference = real_mean_stretch - batsim_mean_stretch
mean_waiting_time_difference = real_mean_waiting_time - batsim_mean_waiting_time
mean_turnaround_time_difference = real_mean_turnaround_time - batsim_mean_turnaround_time

export_data = data.frame(submission_time_difference_mean = double(),
                         submission_time_difference_sd = double(),
                         execution_time_difference_mean = double(),
                         execution_time_difference_sd = double(),
                         waiting_time_difference_mean = double(),
                         waiting_time_difference_sd = double(),
                         turnaround_time_difference_mean = double(),
                         turnaround_time_difference_sd = double(),
                         stretch_difference_mean = double(),
                         stretch_difference_sd = double(),
                         makespan_difference = double(),
                         mean_stretch_difference = double(),
                         mean_waiting_time_difference = double(),
                         mean_turnaround_time_difference = double(),
                         workload_name = character(),
                         batsim_makespan = double(),
                         real_makespan = double(),
                         batsim_mean_stretch = double(),
                         real_mean_stretch = double(),
                         batsim_mean_waiting_time = double(),
                         real_mean_waiting_time = double(),
                         batsim_mean_turnaround_time = double(),
                         real_mean_turnaround_time = double(),
                         stringsAsFactors=FALSE)

export_data[1,] = c(submission_time_difference_mean,
                   submission_time_difference_sd,
                   execution_time_difference_mean,
                   execution_time_difference_sd,
                   waiting_time_difference_mean,
                   waiting_time_difference_sd,
                   turnaround_time_difference_mean,
                   turnaround_time_difference_sd,
                   stretch_difference_mean,
                   stretch_difference_sd,
                   makespan_difference,
                   mean_stretch_difference,
                   mean_waiting_time_difference,
                   mean_turnaround_time_difference,
                   workload_name,
                   batsim_makespan,
                   real_makespan,
                   batsim_mean_stretch,
                   real_mean_stretch,
                   batsim_mean_waiting_time,
                   real_mean_waiting_time,
                   batsim_mean_turnaround_time,
                   real_mean_turnaround_time)

write.table(export_data, "differences.csv", sep=',', row.names=FALSE, quote=FALSE)
