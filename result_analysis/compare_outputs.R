#!/usr/bin/env Rscript
args = commandArgs(trailingOnly=TRUE)

# Loading libraries
library(plyr)
library(ggplot2)

# Reading input arguments
usage = "This script should be called this way:
Rscript --vanilla compare_outputs.R BATSIM REAL OUTPUT_DIR
    BATSIM: the Batsim _jobs.csv output
    REAL: the OAR output is a the same format as BATSIM_OUTPUT
    OUTPUT_DIR: the directory in which the figures generated by this script are outputted"

if (length(args)!=3)
    stop(usage, call.=FALSE)

if (!dir.exists(args[3]))
    stop("Invalid OUTPUT_DIR parameter: directory does not exist", call.=FALSE)

batsim = read.csv(args[1])
real = read.csv(args[2])
output_dir = args[3]

# Setting working directory to OUTPUT_DIR
setwd(output_dir)

# TOREMOVE: test-only purpose
real$submission_time = real$submission_time + 1000
real$execution_time = real$execution_time + 100

# Data manipulations
# Renaming columns to do an inner join
rename_mapping = c(
"jobID"="jobID",
"requested_number_of_processors"="real_requested_number_of_processors",
"success"="real_success",
"execution_time"="real_execution_time",
"waiting_time"="real_waiting_time",
"stretch"="real_stretch",
"allocated_processors"="real_allocated_processors",
"submission_time"="real_submission_time",
"requested_time"="real_requested_time",
"starting_time"="real_starting_time",
"finish_time"="real_finish_time",
"turnaround_time"="real_turnaround_time",
"consumed_energy"="real_consumed_energy")

real_renamed = rename(real, rename_mapping)

m = merge(batsim, real_renamed, by="jobID")
m['submission_time_difference'] = m$real_submission_time - m$submission_time
m['execution_time_difference'] = m$real_execution_time - m$execution_time
m['waiting_time_difference'] = m$real_waiting_time - m$waiting_time
m['turnaround_time_difference'] = m$real_turnaround_time - m$turnaround_time
m['stretch_difference'] = m$real_stretch - m$stretch

batsim["simulated"] = TRUE
real["simulated"] = FALSE
alldata = rbind(batsim, real)

# Graph generation

#pdf("submission_times.pdf")
# plot(batsim$submission_time ~ batsim$jobID,
#     xlab="Job ID", ylab="Submission time",
#     main="Submission times of jobs")
# points(real$submission_time ~ real$jobID)
#dev.off()

# Submission times
ggplot(alldata, aes(x= jobID, y=submission_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("submission_times.pdf")

# Execution times
ggplot(alldata, aes(x= jobID, y=execution_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("execution_times_scatterplot.pdf")

ggplot(alldata, aes(x= execution_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("execution_times_distribution_density.pdf")

ggplot(alldata, aes(x= execution_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("execution_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= execution_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("execution_times_distribution_boxplot.pdf")

# Waiting times
ggplot(alldata, aes(x= submission_time, y= waiting_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("waiting_times_scatterplot.pdf")

ggplot(alldata, aes(x= waiting_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("waiting_times_distribution_density.pdf")

ggplot(alldata, aes(x= waiting_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("waiting_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= waiting_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("waiting_times_distribution_boxplot.pdf")

# Turnaround time
ggplot(alldata, aes(x= submission_time, y= turnaround_time)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("turnaround_times_scatterplot.pdf")

ggplot(alldata, aes(x= turnaround_time, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("turnaround_times_distribution_density.pdf")

ggplot(alldata, aes(x= turnaround_time, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("turnaround_times_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= turnaround_time, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("turnaround_times_distribution_boxplot.pdf")

# Stretch
ggplot(alldata, aes(x= submission_time, y= stretch)) +
    geom_point(aes(color = simulated, shape = simulated))
ggsave("stretch_scatterplot.pdf")

ggplot(alldata, aes(x= stretch, fill = simulated)) +
    geom_density(alpha=.3)
ggsave("stretch_distribution_density.pdf")

ggplot(alldata, aes(x= stretch, fill = simulated)) +
    geom_histogram(binwidth=15, position="dodge")
ggsave("stretch_distribution_histogram.pdf")

ggplot(alldata, aes(x = simulated, y= stretch, fill = simulated)) +
    geom_boxplot() + guides(fill=FALSE)
ggsave("stretch_distribution_boxplot.pdf")

# Job-by-job differences
ggplot(m, aes(x= jobID, y= submission_time_difference)) +
    geom_point()
ggsave("submission_time_difference.pdf")

ggplot(m, aes(x= jobID, y= execution_time_difference)) +
    geom_point()
ggsave("execution_time_difference.pdf")

ggplot(m, aes(x= jobID, y= waiting_time_difference)) +
    geom_point()
ggsave("waiting_time_difference.pdf")

ggplot(m, aes(x= jobID, y= turnaround_time_difference)) +
    geom_point()
ggsave("turnaround_time_difference.pdf")

ggplot(m, aes(x= jobID, y= stretch_difference)) +
    geom_point()
ggsave("stretch_difference.pdf")
